name: SFU Timetable Monitor

on:
  schedule:
    - cron: '*/10 6-23 * * *'  # –ö–∞–∂–¥—ã–µ 10 –º–∏–Ω—É—Ç —Å 6:00 –¥–æ 23:00
  workflow_dispatch:            # –í–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å –∑–∞–ø—É—Å—Ç–∏—Ç—å –≤—Ä—É—á–Ω—É—é

jobs:
  check-timetable:
    runs-on: ubuntu-latest
    steps:
      - name: –ü—Ä–æ–≤–µ—Ä—è–µ–º, –ø–æ—è–≤–∏–ª–æ—Å—å –ª–∏ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ
        id: check
        run: |
          # –î–µ–ª–∞–µ–º –∑–∞–ø—Ä–æ—Å –∫ –∞–≤—Ç–æ–∑–∞–ø–æ–ª–Ω–µ–Ω–∏—é –ø–æ "–∫–∏"
          response=$(curl -s "https://edu.sfu-kras.ru/timetable/groups/autocomplete/%D0%BA%D0%B823")
          echo "–û—Ç–≤–µ—Ç –æ—Ç API: $response"
          
          # –ï—Å–ª–∏ –≤ –æ—Ç–≤–µ—Ç–µ –µ—Å—Ç—å –∑–∞–ø—è—Ç–∞—è ‚Äî –∑–Ω–∞—á–∏—Ç, –µ—Å—Ç—å –≥—Ä—É–ø–ø—ã (—Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ –≤—ã–ª–æ–∂–µ–Ω–æ)
          if [[ "$response" == *","* ]]; then
            echo "timetable_found=true" >> $GITHUB_ENV
            echo "‚úÖ –†–∞—Å–ø–∏—Å–∞–Ω–∏–µ –Ω–∞–π–¥–µ–Ω–æ! –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ."
          else
            echo "–†–∞—Å–ø–∏—Å–∞–Ω–∏–µ –µ—â—ë –Ω–µ –¥–æ—Å—Ç—É–ø–Ω–æ."
            exit 1  # –ü—Ä–µ—Ä—ã–≤–∞–µ–º job, –Ω–æ –Ω–µ workflow ‚Äî —á—Ç–æ–±—ã –ø—Ä–æ–¥–æ–ª–∂–∞–ª –ø—Ä–æ–≤–µ—Ä—è—Ç—å
          fi

      - name: –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –≤ Telegram
        if: env.timetable_found == 'true'
        run: |
          url="https://api.telegram.org/bot${{ secrets.TELEGRAM_TOKEN }}/sendMessage"
          message="üéâ –†–∞—Å–ø–∏—Å–∞–Ω–∏–µ –¥–ª—è –≥—Ä—É–ø–ø –ö–ò –≤—ã–ª–æ–∂–µ–Ω–æ!üëâ https://edu.sfu-kras.ru/timetable"
          response=$(curl -s -X POST "$url" \
            -d chat_id="${{ secrets.TELEGRAM_CHAT_ID }}" \
            -d text="$message" \
            -d disable_notification=false)
          
          echo "–û—Ç–≤–µ—Ç Telegram: $response"
          
          if echo "$response" | grep -q '"ok":false'; then
            echo "‚ùå –û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è"
            exit 1
          fi

      - name: –û—Ç–∫–ª—é—á–∞–µ–º workflow –ø–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–π –æ—Ç–ø—Ä–∞–≤–∫–∏
        if: env.timetable_found == 'true'
        run: |
          echo "–û—Ç–∫–ª—é—á–∞–µ–º workflow, —á—Ç–æ–±—ã –Ω–µ –∑–∞–ø—É—Å–∫–∞–ª—Å—è —Å–Ω–æ–≤–∞..."
          curl -X PATCH \
            -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" \
            -H "Accept: application/vnd.github.v3+json" \
            "https://api.github.com/repos/${{ github.repository }}/actions/workflows/timetable-monitor.yml/disable"
